include ../../mk/util.mk

SKETCHCPP_SRC_GCS_MAVLINK := gcs_mavlink_test_unit.cpp ../../ArduCopter/GCS_Mavlink.pde
SKETCHCPP_SRC_LOGIC := commands_logic_test_unit.cpp ../../ArduCopter/commands_logic.pde
SKETCHCPP_SRC_GUIDED := control_guided_test_unit.cpp ../../ArduCopter/control_guided.pde

sketch-gcs-mavlink:
	mkdir -p generated_files
	gawk -v mode=header '$(SKETCH_SPLITTER)'   $(SKETCHCPP_SRC_GCS_MAVLINK) >  gcs_mavlink_test_unit.new
	@echo "#line 1 \"autogenerated\""                                       >> gcs_mavlink_test_unit.new
	gawk                '$(SKETCH_PROTOTYPER)' $(SKETCHCPP_SRC_GCS_MAVLINK) >> gcs_mavlink_test_unit.new
	gawk -v mode=body   '$(SKETCH_SPLITTER)'   $(SKETCHCPP_SRC_GCS_MAVLINK) >> gcs_mavlink_test_unit.new
	@cmp gcs_mavlink_test_unit gcs_mavlink_test_unit.new > /dev/null 2>&1 || mv gcs_mavlink_test_unit.new gcs_mavlink_test_unit
	rm -f gcs_mavlink_test_unit.new
	mv gcs_mavlink_test_unit generated_files/gcs_mavlink_test_unit.cpp
	
build-gcs-mavlink:
	g++ \
	-I ../../libraries/GCS_MAVLink/include/mavlink/v1.0/ardupilotmega/ \
	-I ../../libraries/GCS_MAVLink/include/mavlink/v1.0/ \
	-I . \
	-w -g -o generated_files/unit_tests generated_files/gcs_mavlink_test_unit.cpp test_suite.cpp
	
run-gcs-mavlink:
	./generated_files/unit_tests
	
test-gcs-mavlink: sketch-gcs-mavlink build-gcs-mavlink run-gcs-mavlink

sketch-logic:
	mkdir -p generated_files
	gawk -v mode=header '$(SKETCH_SPLITTER)'   $(SKETCHCPP_SRC_LOGIC) >  command_logics_test_unit.new
	@echo "#line 1 \"autogenerated\""                                 >> command_logics_test_unit.new
	gawk                '$(SKETCH_PROTOTYPER)' $(SKETCHCPP_SRC_LOGIC) >> command_logics_test_unit.new
	gawk -v mode=body   '$(SKETCH_SPLITTER)'   $(SKETCHCPP_SRC_LOGIC) >> command_logics_test_unit.new
	@cmp command_logics_test_unit command_logics_test_unit.new > /dev/null 2>&1 || mv command_logics_test_unit.new command_logics_test_unit
	rm -f command_logics_test_unit.new
	mv command_logics_test_unit generated_files/command_logics_test_unit.cpp
	
build-logic:
	g++ \
	-I ../../libraries/GCS_MAVLink/include/mavlink/v1.0/ardupilotmega/ \
	-I ../../libraries/GCS_MAVLink/include/mavlink/v1.0/ \
	-I . \
	-w -g -o generated_files/unit_tests-logic generated_files/command_logics_test_unit.cpp test_suite.cpp
	
run-logic:
	./generated_files/unit_tests-logic
	
test-logic: sketch-logic build-logic run-logic

sketch-guided:
	mkdir -p generated_files
	gawk -v mode=header '$(SKETCH_SPLITTER)'   $(SKETCHCPP_SRC_GUIDED) >  control_guided_test_unit.new
	@echo "#line 1 \"autogenerated\""                                  >> control_guided_test_unit.new
	gawk                '$(SKETCH_PROTOTYPER)' $(SKETCHCPP_SRC_GUIDED) >> control_guided_test_unit.new
	gawk -v mode=body   '$(SKETCH_SPLITTER)'   $(SKETCHCPP_SRC_GUIDED) >> control_guided_test_unit.new
	@cmp control_guided_test_unit control_guided_test_unit.new > /dev/null 2>&1 || mv control_guided_test_unit.new control_guided_test_unit
	rm -f control_guided_test_unit.new
	mv control_guided_test_unit generated_files/control_guided_test_unit.cpp
	
build-guided:
	g++ \
	-I ../../libraries/GCS_MAVLink/include/mavlink/v1.0/ardupilotmega/ \
	-I ../../libraries/GCS_MAVLink/include/mavlink/v1.0/ \
	-I . \
	-w -g -o generated_files/unit_tests-guided generated_files/control_guided_test_unit.cpp test_suite.cpp
	
run-guided:
	./generated_files/unit_tests-guided
	
test-guided: sketch-guided build-guided run-guided

test: test-gcs-mavlink test-logic test-guided
	
clean:
	rm -rf generated_files
